# Stage 1: Build the .NET application
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src

# Copy project files for restore
COPY src/backend/BackupChrono.Core/*.csproj ./BackupChrono.Core/
COPY src/backend/BackupChrono.Infrastructure/*.csproj ./BackupChrono.Infrastructure/
COPY src/backend/BackupChrono.Api/*.csproj ./BackupChrono.Api/

# Restore dependencies for API project only
RUN dotnet restore BackupChrono.Api/BackupChrono.Api.csproj

# Copy source code
COPY src/backend/BackupChrono.Core/ ./BackupChrono.Core/
COPY src/backend/BackupChrono.Infrastructure/ ./BackupChrono.Infrastructure/
COPY src/backend/BackupChrono.Api/ ./BackupChrono.Api/

# Build and publish the application
RUN dotnet publish BackupChrono.Api/BackupChrono.Api.csproj -c Release -o /app/publish

# Stage 2: Download and prepare restic binary
FROM alpine:3.19 AS restic
RUN apk add --no-cache wget ca-certificates \
    && wget --tries=3 https://github.com/restic/restic/releases/download/v0.18.1/restic_0.18.1_linux_amd64.bz2 \
    && echo "680838f19d67151adba227e1570cdd8af12c19cf1735783ed1ba928bc41f363d  restic_0.18.1_linux_amd64.bz2" | sha256sum -c - \
    && bunzip2 restic_0.18.1_linux_amd64.bz2 \
    && mv restic_0.18.1_linux_amd64 /usr/local/bin/restic \
    && chmod +x /usr/local/bin/restic

# Stage 3: Runtime image
FROM mcr.microsoft.com/dotnet/aspnet:8.0
WORKDIR /app

# Install git for configuration management
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

# Copy published application
COPY --from=build /app/publish .

# Copy restic binary
COPY --from=restic /usr/local/bin/restic /usr/local/bin/restic

# Create directories for volumes
RUN mkdir -p /config /repository

# Environment variables
ENV ASPNETCORE_URLS=http://+:5000 \
    GIT_CONFIG_PATH=/config \
    RESTIC_REPOSITORY=/repository \
    RESTIC_PASSWORD_FILE=/app/restic-password

EXPOSE 5000

ENTRYPOINT ["dotnet", "BackupChrono.Api.dll"]
